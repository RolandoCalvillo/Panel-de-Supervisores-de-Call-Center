<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Supervisores de Call Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Scripts de Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .dashboard-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; position: relative; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: background-color 0.2s; }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .input-field { border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem 0.75rem; width: 100%; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-field:focus { border-color: #2563eb; box-shadow: 0 0 0 2px #bfdbfe; outline: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .disabled-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem;
            border-radius: 0.75rem;
            z-index: 10;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Vista de Login -->
    <div id="login-view" class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-md">
            <div class="dashboard-card text-center">
                 <i data-lucide="headphones" class="mx-auto h-12 w-12 text-blue-600"></i>
                <h1 class="text-2xl font-bold mt-2">Plataforma de Análisis de Llamadas</h1>
                <p class="text-gray-500 mb-6">Inicia sesión para continuar</p>
                <button id="login-btn" class="btn btn-primary w-full">
                    <svg class="mr-2 -ml-1 w-4 h-4" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 21.2 174.4 54.4l-82.3 82.3C291.1 116.5 270.9 108 248 108c-73.2 0-133.1 59.9-133.1 133.1s59.9 133.1 133.1 133.1c76.1 0 124.2-60.8 129.2-108.2H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"></path></svg>
                    Iniciar Sesión con Google
                </button>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
            </div>
        </div>
    </div>

    <!-- Vista del Dashboard Principal -->
    <div id="dashboard-view" class="hidden">
        <header class="bg-white shadow-md p-4 flex justify-between items-center">
            <div class="flex items-center">
                <i data-lucide="headphones" class="h-8 w-8 text-blue-600"></i>
                <h1 class="text-xl font-bold ml-2">Panel de Supervisor</h1>
            </div>
            <div class="flex items-center">
                <img id="user-avatar" class="h-8 w-8 rounded-full mr-2">
                <p class="mr-4">Bienvenido, <span id="user-name" class="font-semibold"></span></p>
                <button id="logout-btn" class="btn btn-danger">
                    <i data-lucide="log-out" class="mr-2 h-4 w-4"></i>
                    Salir
                </button>
            </div>
        </header>

        <main class="p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna Izquierda: Herramientas -->
            <div class="lg:col-span-1 flex flex-col gap-8">
                 <!-- Tarjeta para Cargar y Transcribir Audios -->
                <div id="upload-card" class="dashboard-card">
                    <div id="upload-card-overlay" class="disabled-overlay hidden">
                        <div class="text-center text-gray-600 font-medium">
                            <i data-lucide="lock" class="mx-auto h-8 w-8 mb-2"></i>
                            <p>Conecta con Google Drive y selecciona una carpeta para habilitar la carga de audios.</p>
                        </div>
                    </div>
                    <h2 class="text-lg font-semibold mb-4 flex items-center"><i data-lucide="upload-cloud" class="mr-2 h-5 w-5"></i>Cargar y Transcribir Audios con Gemini</h2>
                    <form id="upload-audio-form">
                         <div class="mb-4">
                            <label for="upload-audio-files" class="block text-sm font-medium text-gray-700 mb-1">Archivos de Audio</label>
                            <input type="file" id="upload-audio-files" class="input-field" multiple accept="audio/wav, audio/mp3, audio/flac, audio/ogg" required>
                        </div>
                        <div class="mb-4">
                            <label for="upload-agent-select" class="block text-sm font-medium text-gray-700 mb-1">Asesor</label>
                            <select id="upload-agent-select" class="input-field" required></select>
                        </div>
                        <div class="mb-4">
                            <label for="upload-call-type-select" class="block text-sm font-medium text-gray-700 mb-1">Tipo de llamada</label>
                            <select id="upload-call-type-select" class="input-field" required></select>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">
                            <i data-lucide="zap" class="mr-2 h-4 w-4"></i>Procesar y Subir a Drive
                        </button>
                    </form>
                    <div id="upload-status" class="mt-4 text-sm"></div>
                </div>

                <!-- NUEVA SECCIÓN: Conexión a Google Drive -->
                <div class="dashboard-card">
                    <h2 class="text-lg font-semibold mb-4 flex items-center"><i data-lucide="cloud" class="mr-2 h-5 w-5"></i>Conexión a la Nube (Drive)</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        Conecta tu cuenta para guardar y leer transcripciones desde una carpeta de Google Drive.
                    </p>
                    <div id="drive-auth-buttons">
                         <p class="text-sm text-gray-500 text-center">Usa el mismo inicio de sesión de Google.</p>
                    </div>
                    <div id="drive-status" class="mt-4 text-center"></div>
                </div>
                
                <!-- Tarjeta para Gestionar Asesores -->
                <div class="dashboard-card">
                    <h2 class="text-lg font-semibold mb-4 flex items-center"><i data-lucide="users" class="mr-2 h-5 w-5"></i>Gestionar Asesores</h2>
                    <form id="add-agent-form" class="flex gap-2 mb-4">
                        <input type="text" id="agent-name-input" class="input-field flex-grow" placeholder="Nombre del asesor" required>
                        <button type="submit" class="btn btn-primary">Añadir</button>
                    </form>
                    <div id="agent-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>

                <!-- Gestionar Tipos de Llamada y Criterios -->
                <div class="dashboard-card">
                    <h2 class="text-lg font-semibold mb-4 flex items-center"><i data-lucide="clipboard-list" class="mr-2 h-5 w-5"></i>Gestionar Tipos de Llamada</h2>
                    <form id="add-call-type-form" class="flex gap-2 mb-4">
                        <input type="text" id="call-type-name-input" class="input-field flex-grow" placeholder="Ej: Retención, Ventas" required>
                        <button type="submit" class="btn btn-primary">Crear Tipo</button>
                    </form>
                    <div id="call-types-list" class="space-y-4 max-h-60 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Columna Derecha: Análisis y Reportes -->
            <div class="lg:col-span-2 flex flex-col gap-8">
                <!-- Tarjeta de Análisis de Llamadas -->
                <div class="dashboard-card">
                    <h2 class="text-lg font-semibold mb-4 flex items-center"><i data-lucide="bar-chart-3" class="mr-2 h-5 w-5"></i>Análisis de Llamadas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                         <div>
                            <label for="filter-agent" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Asesor</label>
                            <select id="filter-agent" class="input-field"><option value="all">Todos los asesores</option></select>
                        </div>
                         <div>
                            <label for="filter-date" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Fecha</label>
                            <input type="date" id="filter-date" class="input-field">
                        </div>
                    </div>
                    <div id="kpi-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center"></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-gray-600 uppercase">
                                <tr>
                                    <th class="p-3">Asesor</th>
                                    <th class="p-3">Fecha</th>
                                    <th class="p-3">Sentimiento</th>
                                    <th class="p-3">Tipo</th>
                                    <th class="p-3">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="calls-table-body"></tbody>
                        </table>
                    </div>
                     <div id="no-calls-message" class="text-center py-8 text-gray-500 hidden">
                        <i data-lucide="inbox" class="mx-auto h-12 w-12 text-gray-400"></i>
                        <p class="mt-2">No hay llamadas para mostrar con los filtros actuales.</p>
                    </div>
                </div>
                
                <!-- Tarjeta de Análisis con IA -->
                <div class="dashboard-card">
                    <h2 class="text-lg font-semibold mb-4 flex items-center"><i data-lucide="sparkles" class="mr-2 h-5 w-5 text-yellow-500"></i>Análisis con IA y Reportes</h2>
                    <form id="ai-report-form">
                        <div class="mb-4">
                            <label for="ai-prompt" class="block text-sm font-medium text-gray-700 mb-1">¿Qué deseas analizar?</label>
                            <textarea id="ai-prompt" rows="3" class="input-field" placeholder="Ej: Resume los principales motivos de queja de los clientes y sugiere mejoras." required></textarea>
                        </div>
                        <p class="text-sm font-medium text-gray-700 mb-2">Filtrar transcripciones para el análisis:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label for="ai-filter-agent" class="block text-xs text-gray-600 mb-1">Asesor</label>
                                <select id="ai-filter-agent" class="input-field"><option value="all">Todos</option></select>
                            </div>
                            <div>
                                <label for="ai-filter-call-type" class="block text-xs text-gray-600 mb-1">Tipo Llamada</label>
                                <select id="ai-filter-call-type" class="input-field"><option value="all">Todos</option></select>
                            </div>
                            <div>
                                <label for="ai-filter-date-start" class="block text-xs text-gray-600 mb-1">Desde</label>
                                <input type="date" id="ai-filter-date-start" class="input-field">
                            </div>
                             <div>
                                <label for="ai-filter-date-end" class="block text-xs text-gray-600 mb-1">Hasta</label>
                                <input type="date" id="ai-filter-date-end" class="input-field">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-full bg-indigo-600 hover:bg-indigo-700">
                            <i data-lucide="wand-2" class="mr-2 h-4 w-4"></i>Generar Reporte
                        </button>
                    </form>
                    <div id="ai-report-status" class="mt-4"></div>
                    <div id="ai-report-output" class="mt-4 border-t pt-4 hidden">
                         <div class="flex justify-between items-center mb-2">
                            <h3 class="text-md font-semibold">Reporte Generado por IA</h3>
                            <button id="download-pdf-btn" class="btn btn-secondary">
                               <i data-lucide="download" class="mr-2 h-4 w-4"></i>Descargar PDF
                            </button>
                         </div>
                         <div class="bg-gray-50 p-4 rounded-lg max-h-60 overflow-y-auto">
                            <p id="ai-report-content" class="text-gray-700 whitespace-pre-wrap"></p>
                         </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para ver transcripción -->
    <div id="transcript-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="dashboard-card w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Transcripción de la Llamada</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="h-6 w-6"></i></button>
            </div>
            <div id="modal-content" class="overflow-y-auto">
                <p class="font-semibold">Asesor: <span id="modal-agent"></span></p>
                <p class="font-semibold">Fecha: <span id="modal-date"></span></p>
                <p class="font-semibold mb-4">Tipo: <span id="modal-call-type"></span></p>
                <div class="bg-gray-50 p-4 rounded-lg"><p id="modal-transcript" class="text-gray-700 whitespace-pre-wrap"></p></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configuración de Firebase (proporcionada por el usuario)
        const firebaseConfig = {
            apiKey: "AIzaSyC8jIUPHKmcKy7eO1aq6eS4ZJ6kfq4zrBo",
            authDomain: "apppaneldesupcallcenter.firebaseapp.com",
            projectId: "apppaneldesupcallcenter",
            storageBucket: "apppaneldesupcallcenter.firebasestorage.app",
            messagingSenderId: "1091325080953",
            appId: "1:1091325080953:web:14fd225a15f532f92feba8",
            measurementId: "G-MGBBK91GZR"
        };
        
        // ===================================================================================
        // NOTA PARA EL DESARROLLADOR: 
        // Si recibes un error "auth/unauthorized-domain", es una medida de seguridad de Firebase.
        // SOLUCIÓN:
        // 1. Ve a tu consola de Firebase: https://console.firebase.google.com/
        // 2. Entra en tu proyecto ("apppaneldesupcallcenter").
        // 3. Ve a la sección "Authentication" -> Pestaña "Settings".
        // 4. En "Authorized domains", haz clic en "Add domain".
        // 5. Añade el dominio desde donde ejecutas la app (ej: "rolandocalvillo.github.io" o "localhost").
        // ===================================================================================


        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        provider.addScope('https://www.googleapis.com/auth/drive.file');

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // Referencias a elementos del DOM
            const loginView = document.getElementById('login-view'), dashboardView = document.getElementById('dashboard-view');
            const loginBtn = document.getElementById('login-btn'), loginError = document.getElementById('login-error');
            const userAvatar = document.getElementById('user-avatar'), userName = document.getElementById('user-name'), logoutBtn = document.getElementById('logout-btn');
            const addAgentForm = document.getElementById('add-agent-form'), agentNameInput = document.getElementById('agent-name-input'), agentList = document.getElementById('agent-list');
            const addCallTypeForm = document.getElementById('add-call-type-form'), callTypeNameInput = document.getElementById('call-type-name-input'), callTypesList = document.getElementById('call-types-list');
            const filterAgent = document.getElementById('filter-agent'), filterDate = document.getElementById('filter-date');
            const kpiContainer = document.getElementById('kpi-container'), callsTableBody = document.getElementById('calls-table-body'), noCallsMessage = document.getElementById('no-calls-message');
            const transcriptModal = document.getElementById('transcript-modal'), closeModalBtn = document.getElementById('close-modal-btn'), modalAgent = document.getElementById('modal-agent'), modalDate = document.getElementById('modal-date'), modalTranscript = document.getElementById('modal-transcript'), modalCallType = document.getElementById('modal-call-type');
            const aiReportForm = document.getElementById('ai-report-form'), aiPrompt = document.getElementById('ai-prompt'), aiFilterAgent = document.getElementById('ai-filter-agent'), aiFilterCallType = document.getElementById('ai-filter-call-type'), aiFilterDateStart = document.getElementById('ai-filter-date-start'), aiFilterDateEnd = document.getElementById('ai-filter-date-end'), aiReportStatus = document.getElementById('ai-report-status'), aiReportOutput = document.getElementById('ai-report-output'), aiReportContent = document.getElementById('ai-report-content'), downloadPdfBtn = document.getElementById('download-pdf-btn');
            
            const uploadCardOverlay = document.getElementById('upload-card-overlay');
            const uploadAudioForm = document.getElementById('upload-audio-form');
            const uploadAudioFiles = document.getElementById('upload-audio-files');
            const uploadAgentSelect = document.getElementById('upload-agent-select');
            const uploadCallTypeSelect = document.getElementById('upload-call-type-select');
            const uploadStatus = document.getElementById('upload-status');

            const driveStatus = document.getElementById('drive-status');
            
            let currentUser = null;
            let gapiInited = false;
            let driveFolderId = null;
            let allCalls = []; // Estado local para las llamadas

            // --- CONFIGURACIÓN DE GOOGLE API ---
            const API_KEY = 'AIzaSyDwEp9evd14zy9R8QejwjdIpzjqpNpydIM'; 
            const CLIENT_ID = '533972320346-10pg9nle56icqb5u980k0k0aru8kicjd.apps.googleusercontent.com';
            const DISCOVERY_DOC_DRIVE = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

            // --- Lógica de Autenticación de Firebase ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    loginView.classList.add('hidden');
                    dashboardView.classList.remove('hidden');
                    gapi.load('client:picker', initializeGapiClient);
                    setupDashboard();
                } else {
                    currentUser = null;
                    loginView.classList.remove('hidden');
                    dashboardView.classList.add('hidden');
                }
            });

            loginBtn.onclick = () => {
                signInWithPopup(auth, provider)
                    .catch((error) => {
                        console.error("Error de inicio de sesión:", error);
                        loginError.textContent = `Error: ${error.message}`;
                    });
            };

            logoutBtn.onclick = () => signOut(auth);

            async function setupDashboard() {
                userName.textContent = currentUser.displayName;
                userAvatar.src = currentUser.photoURL;
                setupRealtimeListeners();
                updateUploadCardState();
            }
            
            async function initializeGapiClient() {
                const credential = GoogleAuthProvider.credentialFromResult(await auth.currentUser.getIdTokenResult());
                 const tokenResponse = {
                    access_token: auth.currentUser.stsTokenManager.accessToken,
                    expires_in: 3600,
                };

                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC_DRIVE] });
                gapi.client.setToken(tokenResponse);
                gapiInited = true;
                
                // Cargar datos de la carpeta de Drive desde Firestore
                const userSettingsDoc = await getDoc(doc(db, "userSettings", currentUser.uid));
                if (userSettingsDoc.exists() && userSettingsDoc.data().driveFolderId) {
                    driveFolderId = userSettingsDoc.data().driveFolderId;
                    driveStatus.innerHTML = `<p class="text-green-600 text-sm">Carpeta de Drive conectada.</p>`;
                } else {
                    driveStatus.innerHTML = `<button id="select-folder-btn" class="text-blue-600 underline">Selecciona la carpeta de transcripciones</button>`;
                }
                 updateUploadCardState();
            }
            
            // --- Listeners de Firestore en tiempo real ---
            function setupRealtimeListeners() {
                onSnapshot(collection(db, "agents"), (snapshot) => {
                    const agents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAgentList(agents);
                    populateSelectsWithData(agents.map(a => a.name), [filterAgent, aiFilterAgent, uploadAgentSelect]);
                });

                onSnapshot(collection(db, "callTypes"), (snapshot) => {
                    const callTypes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCallTypesManagement(callTypes);
                    populateSelectsWithData(callTypes.map(c => c.name), [aiFilterCallType, uploadCallTypeSelect]);
                });
                
                onSnapshot(query(collection(db, "calls")), (snapshot) => {
                    allCalls = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                    renderAnalytics();
                });
            }

            function updateUploadCardState() {
                if (driveFolderId) {
                    uploadCardOverlay.classList.add('hidden');
                } else {
                    uploadCardOverlay.classList.remove('hidden');
                }
                lucide.createIcons();
            }

            driveStatus.addEventListener('click', (e) => {
                if(e.target.id === 'select-folder-btn') createPicker();
            });

            function createPicker() {
                if (!gapiInited) return;
                const view = new google.picker.View(google.picker.ViewId.FOLDERS);
                const picker = new google.picker.PickerBuilder()
                    .setAppId(null)
                    .setOAuthToken(gapi.client.getToken().access_token)
                    .setDeveloperKey(API_KEY)
                    .addView(view)
                    .setLocale('es')
                    .setCallback(pickerCallback)
                    .build();
                picker.setVisible(true);
            }

            async function pickerCallback(data) {
                if (data.action === google.picker.Action.PICKED) {
                    const folder = data.docs[0];
                    driveFolderId = folder.id;
                    await setDoc(doc(db, "userSettings", currentUser.uid), { driveFolderId: folder.id, driveFolderName: folder.name }, { merge: true });
                    driveStatus.innerHTML = `<p class="text-green-600 text-sm">Carpeta "${folder.name}" conectada.</p>`;
                    updateUploadCardState();
                }
            }
            
            // --- Lógica de carga, transcripción y guardado ---
            uploadAudioForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                // ... (código idéntico a la versión anterior para procesar y subir, pero al final guardar en Firestore)
                const files = uploadAudioFiles.files;
                const agent = uploadAgentSelect.value;
                const callType = uploadCallTypeSelect.value;
                const today = new Date().toISOString().slice(0, 10);
                const submitBtn = uploadAudioForm.querySelector('button');
                submitBtn.disabled = true;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    uploadStatus.innerHTML = `<div class="flex items-center gap-2"><div class="loader" style="width:20px; height:20px; border-width: 2px;"></div><span>Transcribiendo ${i + 1}/${files.length} con Gemini...</span></div>`;
                    
                    const transcript = await transcribeAudioWithGemini(file);

                    if (transcript) {
                        uploadStatus.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="upload-cloud" class="h-5 w-5 text-blue-500"></i><span>Subiendo transcripción a Drive...</span></div>`;
                        lucide.createIcons();

                        const fileName = `${callType}_${agent}_${today}_${Date.now()}.txt`;
                        const driveFile = await uploadTranscriptionToDrive(fileName, transcript);

                        if(driveFile) {
                            uploadStatus.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="database" class="h-5 w-5 text-green-500"></i><span>Guardando datos en Firebase...</span></div>`;
                            lucide.createIcons();
                            await addDoc(collection(db, "calls"), {
                                agent, callType, date: today, driveFileId: driveFile.id,
                                duration: Math.floor(Math.random() * 300) + 60, // Simulado
                                sentiment: Math.floor(Math.random() * 70) + 30, // Simulado
                                createdBy: currentUser.uid,
                                createdAt: new Date()
                            });
                        }
                    } else {
                         uploadStatus.innerHTML += `<p class="text-red-500">Error al transcribir ${file.name}.</p>`;
                    }
                }
                
                submitBtn.disabled = false;
                uploadAudioForm.reset();
                uploadStatus.innerHTML = `<p class="text-green-600">Proceso completado.</p>`;
                setTimeout(() => { uploadStatus.innerHTML = ''; }, 3000);
            });

            async function transcribeAudioWithGemini(audioFile) {
                 try {
                    const audioData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = reject;
                        reader.readAsDataURL(audioFile);
                    });
                    const prompt = `Eres un experto en transcripción de llamadas de call centers. Transcribe la siguiente conversación de audio. En la conversación hay dos participantes: un "Asesor" y un "Alumno". El asesor se identifica con una frase similar a "soy asesor de la Universidad Virtual CNCI". Tu tarea es transcribir el diálogo y etiquetar claramente las intervenciones de cada uno. Por ejemplo: \nAsesor: [diálogo del asesor]\nAlumno: [diálogo del alumno]`;
                    const requestBody = { contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: audioFile.type, data: audioData } } ] }] };
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                    if (!response.ok) { const error = await response.json(); console.error("Gemini API Error:", error); throw new Error(`Error de Gemini: ${error.error.message}`); }
                    const data = await response.json();
                    if (data.candidates && data.candidates.length > 0) return data.candidates[0].content.parts[0].text;
                    else throw new Error("Respuesta de Gemini no válida.");
                } catch (err) {
                    console.error("Error en transcripción con Gemini:", err);
                    uploadStatus.innerHTML = `<p class="text-red-500">Error: ${err.message}.</p>`;
                    return null;
                }
            }

            async function uploadTranscriptionToDrive(fileName, content) {
                try {
                    const metadata = { name: fileName, mimeType: 'text/plain', parents: [driveFolderId] };
                    const boundary = '-------314159265358979323846';
                    const delimiter = "\r-n--" + boundary + "\r-n";
                    const close_delim = "\r-n--" + boundary + "--";
                    const multipartRequestBody = delimiter + 'Content-Type: application/json\r-n\r-n' + JSON.stringify(metadata) + delimiter + 'Content-Type: text/plain\r-n\r-n' + content + close_delim;
                    const response = await gapi.client.request({ 'path': '/upload/drive/v3/files', 'method': 'POST', 'params': {'uploadType': 'multipart'}, 'headers': { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' }, 'body': multipartRequestBody });
                    return response.result;
                } catch (err) { console.error("Error subiendo a Drive:", err); return null; }
            }

            // --- Lógica de renderizado y gestión ---
            function renderAgentList(agents) { agentList.innerHTML = ''; if(agents.length === 0) agentList.innerHTML = '<p class="text-sm text-gray-500">No hay asesores.</p>'; else agents.forEach(agent => { const div = document.createElement('div'); div.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md'; div.innerHTML = `<span class="text-sm">${agent.name}</span><button data-id="${agent.id}" class="delete-agent-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-4 w-4"></i></button>`; agentList.appendChild(div); }); lucide.createIcons(); }
            addAgentForm.addEventListener('submit', async e => { e.preventDefault(); const agentName = agentNameInput.value.trim(); if (agentName) { await addDoc(collection(db, "agents"), { name: agentName }); agentNameInput.value = ''; } });
            agentList.addEventListener('click', async e => { const btn = e.target.closest('.delete-agent-btn'); if (btn) { await deleteDoc(doc(db, "agents", btn.dataset.id)); } });

            function renderCallTypesManagement(callTypes) { callTypesList.innerHTML = ''; if(callTypes.length === 0) callTypesList.innerHTML = '<p class="text-sm text-gray-500">No hay tipos de llamada.</p>'; else callTypes.forEach(type => { const div = document.createElement('div'); div.className = 'p-2 border rounded-md'; div.innerHTML = `<div class="flex justify-between items-center"><h4 class="font-semibold text-sm">${type.name}</h4><button data-id="${type.id}" class="delete-call-type-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-4 w-4"></i></button></div>`; callTypesList.appendChild(div); }); lucide.createIcons(); }
            addCallTypeForm.addEventListener('submit', async e => { e.preventDefault(); const typeName = callTypeNameInput.value.trim(); if (typeName) { await addDoc(collection(db, "callTypes"), { name: typeName }); callTypeNameInput.value = ''; } });
            callTypesList.addEventListener('click', async e => { const btn = e.target.closest('.delete-call-type-btn'); if (btn) { await deleteDoc(doc(db, "callTypes", btn.dataset.id)); } });

            function populateSelectsWithData(data, selects) { selects.forEach(s => { const currentValue = s.value; s.innerHTML = `<option value="all">${s.id.includes('filter') ? 'Todos' : 'Seleccionar...'}</option>`; data.forEach(item => { s.innerHTML += `<option value="${item}">${item}</option>`; }); s.value = currentValue; }); }
            
            [filterAgent, filterDate].forEach(el => el.addEventListener('change', renderAnalytics));
            function renderAnalytics() { const selectedAgent = filterAgent.value, selectedDate = filterDate.value; let filteredCalls = allCalls.filter(call => (selectedAgent === 'all' || call.agent === selectedAgent) && (!selectedDate || call.date === selectedDate) ); renderKPIs(filteredCalls); renderCallsTable(filteredCalls); }
            function renderKPIs(calls) { kpiContainer.innerHTML = ''; if(calls.length === 0){ kpiContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">No hay datos.</p>'; return; } const totalCalls = calls.length; const avgSentiment = calls.reduce((acc, call) => acc + call.sentiment, 0) / totalCalls || 0; const avgDuration = calls.reduce((acc, call) => acc + call.duration, 0) / totalCalls || 0; const positiveCalls = calls.filter(c => c.sentiment >= 75).length; const kpis = [ { label: 'Total Llamadas', value: totalCalls, icon: 'phone' }, { label: 'Sentimiento Prom.', value: `${avgSentiment.toFixed(1)}%`, icon: 'smile' }, { label: 'Duración Prom.', value: `${avgDuration.toFixed(0)}s`, icon: 'clock' }, { label: 'Llamadas Positivas', value: positiveCalls, icon: 'thumbs-up' } ]; kpis.forEach(kpi => { const div = document.createElement('div'); div.className = 'bg-gray-50 p-4 rounded-lg'; div.innerHTML = `<div class="flex items-center justify-center gap-2"><i data-lucide="${kpi.icon}" class="h-5 w-5 text-blue-600"></i><p class="text-xs text-gray-500 uppercase font-semibold">${kpi.label}</p></div><p class="text-2xl font-bold mt-1">${kpi.value}</p>`; kpiContainer.appendChild(div); }); lucide.createIcons(); }
            function renderCallsTable(calls) { callsTableBody.innerHTML = ''; noCallsMessage.classList.toggle('hidden', calls.length > 0); calls.forEach(call => { const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-gray-50'; const sentimentColor = call.sentiment >= 75 ? 'text-green-600' : call.sentiment < 50 ? 'text-red-600' : 'text-yellow-600'; tr.innerHTML = `<td class="p-3">${call.agent}</td><td class="p-3">${call.date}</td><td class="p-3 font-semibold ${sentimentColor}">${call.sentiment}%</td><td class="p-3 text-xs bg-gray-100 rounded-full text-center">${call.callType}</td><td class="p-3"><button data-drive-id="${call.driveFileId}" class="view-transcript-btn text-blue-600 hover:underline text-sm">Ver</button></td>`; callsTableBody.appendChild(tr); }); }
            
            callsTableBody.addEventListener('click', async (e) => { 
                const btn = e.target.closest('.view-transcript-btn');
                if (btn) {
                    const driveId = btn.dataset.driveId;
                    const call = allCalls.find(c => c.driveFileId === driveId);
                    if (call) {
                         try {
                            const resp = await gapi.client.drive.files.get({ fileId: driveId, alt: 'media' });
                            modalAgent.textContent = call.agent;
                            modalDate.textContent = call.date;
                            modalCallType.textContent = call.callType;
                            modalTranscript.textContent = resp.body;
                            transcriptModal.classList.remove('hidden');
                        } catch (err) {
                            console.error("Error al obtener transcripción de Drive:", err);
                            alert("No se pudo cargar la transcripción.");
                        }
                    }
                }
            });

            closeModalBtn.addEventListener('click', () => transcriptModal.classList.add('hidden'));
            transcriptModal.addEventListener('click', (e) => { if (e.target === transcriptModal) transcriptModal.classList.add('hidden'); });

            aiReportForm.addEventListener('submit', (e) => { e.preventDefault(); const submitBtn = aiReportForm.querySelector('button[type="submit"]'); const agent = aiFilterAgent.value, callType = aiFilterCallType.value, startDate = aiFilterDateStart.value, endDate = aiFilterDateEnd.value, prompt = aiPrompt.value; let callsForAI = allCalls.filter(call => (agent === 'all' || call.agent === agent) && (callType === 'all' || call.callType === callType) && (!startDate || call.date >= startDate) && (!endDate || call.date <= endDate) ); if (callsForAI.length === 0) { aiReportStatus.innerHTML = `<p class="text-yellow-600">No se encontraron llamadas con los filtros.</p>`; aiReportOutput.classList.add('hidden'); return; } submitBtn.disabled = true; aiReportOutput.classList.add('hidden'); aiReportStatus.innerHTML = `<div class="flex items-center gap-2"><div class="loader" style="width:20px; height:20px; border-width: 2px;"></div><p class="text-indigo-600">Analizando ${callsForAI.length} transcripciones...</p></div>`; setTimeout(() => { aiReportContent.textContent = "El análisis con IA real requeriría enviar las transcripciones a un modelo como Gemini. Esta es una simulación del resultado.\n\n" + generateSimulatedReport(prompt, callsForAI); aiReportOutput.classList.remove('hidden'); aiReportStatus.innerHTML = ''; submitBtn.disabled = false; }, 2500); });
            function generateSimulatedReport(prompt, calls) { let report = `Solicitud: "${prompt}"\nLlamadas Analizadas: ${calls.length}\n\n`; const avgSentiment = calls.reduce((acc, c) => acc + c.sentiment, 0) / calls.length; if (prompt.toLowerCase().includes('queja')) { const lowSentimentCalls = calls.filter(c => c.sentiment < 50); report += `--- ANÁLISIS DE PUNTOS DE FRICCIÓN ---\nSe identificaron ${lowSentimentCalls.length} llamadas con sentimiento negativo. Las quejas recurrentes parecen estar relacionadas con [problema simulado 1] y [problema simulado 2].\nSugerencia: Capacitar al equipo en el manejo de objeciones sobre [problema simulado 1].\n`; } else { report += `--- RESUMEN GENERAL ---\nEl sentimiento promedio de las llamadas es de ${avgSentiment.toFixed(1)}%. Se observa que el tema más recurrente es [tema simulado].\n`; } return report; }
            downloadPdfBtn.addEventListener('click', () => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); const reportText = aiReportContent.textContent; const margin = 15; const pageWidth = doc.internal.pageSize.getWidth(); const lines = doc.splitTextToSize(reportText, pageWidth - margin * 2); doc.text(lines, margin, margin); doc.save('reporte-ia.pdf'); });

        });
    </script>
</body>
</html>

