<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Análisis de Llamadas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gris claro de fondo */
        }
        .sidebar-icon {
            transition: all 0.2s ease-in-out;
        }
        .sidebar-icon:hover {
            transform: scale(1.1);
            color: #4f46e5; /* indigo-600 */
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body>

    <!-- Pantalla de Login -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg text-center">
            <div>
                <i class="fas fa-headset text-5xl text-indigo-600"></i>
                <h2 class="mt-6 text-3xl font-bold text-gray-900">Plataforma de Análisis de Llamadas</h2>
                <p class="mt-2 text-sm text-gray-600">Bienvenido. Selecciona tu rol para continuar.</p>
            </div>
            <div class="space-y-4">
                <button id="login-superadmin" class="w-full flex justify-center items-center gap-3 py-3 px-4 text-sm font-semibold rounded-lg border border-transparent bg-indigo-600 text-white hover:bg-indigo-700 transition-all">
                    <i class="fas fa-user-shield"></i> Entrar como Superadministrador
                </button>
                <button id="login-supervisor" class="w-full flex justify-center items-center gap-3 py-3 px-4 text-sm font-semibold rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-all">
                    <i class="fas fa-user-tie"></i> Entrar como Supervisor
                </button>
            </div>
            <p class="text-xs text-gray-500">Esta es una simulación de la interfaz. La lógica de negocio y la IA se ejecutan en el backend.</p>
        </div>
    </div>

    <!-- Aplicación Principal -->
    <div id="app" class="hidden">
        <div class="flex h-screen bg-gray-100">
            <!-- Sidebar -->
            <aside class="w-20 bg-white shadow-md flex flex-col items-center py-6 space-y-8">
                <div class="text-indigo-600">
                   <i class="fas fa-headset text-3xl"></i>
                </div>
                <nav id="nav-menu" class="flex flex-col items-center space-y-6 flex-grow">
                    <!-- Los íconos se agregarán dinámicamente -->
                </nav>
                <div class="pb-4">
                    <button id="logout-btn" class="sidebar-icon text-gray-500 hover:text-red-500" title="Cerrar Sesión">
                        <i class="fas fa-sign-out-alt text-2xl"></i>
                    </button>
                </div>
            </aside>

            <!-- Contenido Principal -->
            <main class="flex-1 p-6 md:p-10 overflow-y-auto">
                <header class="mb-8">
                    <h1 id="header-title" class="text-3xl font-bold text-gray-800">Panel de Control</h1>
                    <p id="user-role-display" class="text-gray-500 mt-1">Rol: Cargando...</p>
                </header>
                
                <div id="content-area">
                    <!-- El contenido se cargará aquí -->
                </div>
            </main>
        </div>
    </div>
    
    <!-- Plantillas de contenido (ocultas por defecto) -->
    <template id="superadmin-dashboard-template">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 slide-in">
            <div class="bg-white p-6 rounded-xl shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Llamadas Procesadas (Hoy)</p>
                    <p class="text-3xl font-bold text-gray-800">1,204</p>
                </div>
                <i class="fas fa-phone-volume text-3xl text-indigo-500 bg-indigo-100 p-4 rounded-full"></i>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Puntuación de Calidad Media</p>
                    <p class="text-3xl font-bold text-gray-800">88.5%</p>
                </div>
                <i class="fas fa-star text-3xl text-green-500 bg-green-100 p-4 rounded-full"></i>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Sentimiento Negativo</p>
                    <p class="text-3xl font-bold text-gray-800">12</p>
                </div>
                <i class="fas fa-face-frown text-3xl text-red-500 bg-red-100 p-4 rounded-full"></i>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Alertas Activas</p>
                    <p class="text-3xl font-bold text-gray-800">3</p>
                </div>
                <i class="fas fa-triangle-exclamation text-3xl text-yellow-500 bg-yellow-100 p-4 rounded-full"></i>
            </div>
        </div>
        <div class="mt-8 bg-white p-6 rounded-xl shadow-sm">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Actividad Reciente del Sistema</h3>
            <p class="text-gray-600">Aquí se mostraría un gráfico con la actividad en tiempo real. </p>
        </div>
    </template>

    <template id="superadmin-config-template">
        <div class="bg-white p-8 rounded-xl shadow-sm slide-in">
            <h2 class="text-xl font-bold text-gray-800 mb-6">Configuración de Disparadores Automáticos</h2>
            <p class="text-gray-600 mb-6">Define qué asesores y campañas activarán la transcripción y análisis automático al finalizar una llamada.</p>
            
            <div class="space-y-8">
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Asesores</h3>
                    <div id="agents-config-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <!-- Los asesores se cargarán aquí -->
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Campañas</h3>
                    <div id="campaigns-config-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <!-- Las campañas se cargarán aquí -->
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="supervisor-calls-template">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-800">Bandeja de Llamadas Recientes</h2>
            <button id="manual-upload-btn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2">
                <i class="fas fa-upload"></i> Carga Manual
            </button>
        </div>
        <div id="calls-list" class="space-y-4">
            <!-- Las llamadas se cargarán aquí -->
        </div>
    </template>

    <!-- Nueva plantilla de Análisis para Supervisor -->
    <template id="supervisor-analysis-template">
        <div class="space-y-8 slide-in">
            <!-- Sección de Filtros -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Filtros de Análisis</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="date-range" class="block text-sm font-medium text-gray-700">Rango de Fechas</label>
                        <input type="date" id="date-range" name="date-range" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="filter-advisors" class="block text-sm font-medium text-gray-700">Asesores</label>
                        <select id="filter-advisors" multiple class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            <!-- Opciones de asesores se cargarán aquí -->
                        </select>
                    </div>
                    <div>
                        <label for="filter-campaigns" class="block text-sm font-medium text-gray-700">Campañas</label>
                        <select id="filter-campaigns" multiple class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            <!-- Opciones de campañas se cargarán aquí -->
                        </select>
                    </div>
                    <div>
                        <label for="prompt-template-select" class="block text-sm font-medium text-gray-700">Plantilla de Prompt</label>
                        <select id="prompt-template-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            <!-- Opciones de plantillas se cargarán aquí -->
                        </select>
                    </div>
                </div>
                <div class="mt-6 text-right">
                    <button id="generate-report-btn" class="bg-indigo-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2 float-right">
                        <i class="fas fa-rocket"></i> Generar Reporte con IA
                    </button>
                </div>
            </div>

            <!-- Sección de Resultados del Reporte -->
            <div id="report-results-area" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Resultados del Análisis</h3>
                    <button id="export-csv-btn" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                        <i class="fas fa-file-csv"></i> Exportar a CSV
                    </button>
                </div>
                <div id="report-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <!-- Resumen del reporte se inyectará aquí -->
                </div>
                <div id="report-details" class="bg-white p-6 rounded-xl shadow-sm">
                    <h4 class="font-semibold mb-4">Detalle de Llamadas Analizadas</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asesor</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Calidad</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sentimiento</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KPIs Clave</th>
                                </tr>
                            </thead>
                            <tbody id="report-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Filas de la tabla del reporte se inyectarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
             <div id="report-placeholder" class="text-center py-16 bg-white rounded-xl shadow-sm">
                <i class="fas fa-chart-bar text-5xl text-gray-300"></i>
                <h3 class="mt-4 text-xl font-semibold text-gray-700">Listo para Analizar</h3>
                <p class="text-gray-500 mt-2">Ajusta los filtros y selecciona una plantilla para generar un nuevo reporte.</p>
             </div>
        </div>
    </template>

    <!-- Nueva plantilla de Plantillas de Prompts -->
    <template id="supervisor-prompts-template">
        <div class="space-y-6 slide-in">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">Mis Plantillas de Prompts</h2>
                <button id="add-prompt-btn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-plus"></i> Nueva Plantilla
                </button>
            </div>
            <div id="prompts-list" class="space-y-4">
                <!-- Las plantillas se cargarán aquí -->
            </div>
        </div>
    </template>
    
    <!-- Modal para Carga Manual -->
    <div id="upload-modal" class="hidden fixed inset-0 z-50 overflow-y-auto flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-8 m-4 max-w-lg w-full">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Carga Manual de Audio</h3>
            <p class="text-gray-600 mb-6">Sube un archivo de audio para transcribirlo y analizarlo. Esto es útil para casos que no forman parte del flujo automático.</p>
            <form id="upload-form">
                <div class="mb-4">
                    <label for="agent-name" class="block text-sm font-medium text-gray-700">Nombre del Asesor</label>
                    <input type="text" id="agent-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="audio-file" class="block text-sm font-medium text-gray-700">Archivo de Audio (.mp3, .wav)</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <i class="fas fa-file-audio text-4xl text-gray-400"></i>
                            <p class="text-sm text-gray-600">Arrastra y suelta un archivo o <span class="text-indigo-600 font-semibold cursor-pointer">búscalo en tu equipo</span></p>
                            <input id="audio-file" name="audio-file" type="file" class="sr-only">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-upload" class="bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700">Iniciar Proceso</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Detalles de Llamada -->
    <div id="call-details-modal" class="hidden fixed inset-0 z-50 overflow-y-auto flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-8 m-4 max-w-3xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Detalles de la Llamada</h3>
                    <p id="modal-call-info" class="text-sm text-gray-500"></p>
                </div>
                <button id="close-details-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="modal-content-container" class="overflow-y-auto flex-grow pr-4">
                <!-- Contenido del modal se carga aquí -->
            </div>
             <div class="flex justify-end space-x-3 pt-4 border-t mt-4">
                <button id="close-details-modal-footer" class="bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300">Cerrar</button>
                <button id="analyze-call-btn" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2">
                    <i class="fas fa-wand-magic-sparkles"></i> Analizar con IA
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Añadir/Editar Prompt -->
    <div id="prompt-modal" class="hidden fixed inset-0 z-50 overflow-y-auto flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-8 m-4 max-w-lg w-full">
            <h3 id="prompt-modal-title" class="text-xl font-bold text-gray-900 mb-4">Nueva Plantilla</h3>
            <form id="prompt-form">
                <input type="hidden" id="prompt-id">
                <div class="mb-4">
                    <label for="prompt-title" class="block text-sm font-medium text-gray-700">Título</label>
                    <input type="text" id="prompt-title" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="prompt-content" class="block text-sm font-medium text-gray-700">Contenido del Prompt</label>
                    <textarea id="prompt-content" rows="6" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-prompt" class="bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700">Guardar Plantilla</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Notificación Toast -->
    <div id="toast-notification" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg text-sm flex items-center gap-2">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message"></span>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, getDocs, setDoc, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- VARIABLES GLOBALES Y CONFIGURACIÓN ---
        const firebaseConfig = {
            apiKey: "AIzaSy...your-api-key", // Reemplazar con tu config
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "your-sender-id",
            appId: "your-app-id"
        };
		
		let app, db, auth;
		let isFirebaseConnected = false;
        let generatedReportData = [];
        
        let currentUserRole = null;
        let unsubscribeCalls = null;
        let unsubscribeConfigs = null;
        let unsubscribePrompts = null;

        const DOM = {
            loginScreen: document.getElementById('login-screen'),
            app: document.getElementById('app'),
            loginSuperadmin: document.getElementById('login-superadmin'),
            loginSupervisor: document.getElementById('login-supervisor'),
            logoutBtn: document.getElementById('logout-btn'),
            navMenu: document.getElementById('nav-menu'),
            contentArea: document.getElementById('content-area'),
            userRoleDisplay: document.getElementById('user-role-display'),
            headerTitle: document.getElementById('header-title'),
            uploadModal: document.getElementById('upload-modal'),
            cancelUpload: document.getElementById('cancel-upload'),
            uploadForm: document.getElementById('upload-form'),
            callDetailsModal: document.getElementById('call-details-modal'),
            closeDetailsModal: document.getElementById('close-details-modal'),
            closeDetailsModalFooter: document.getElementById('close-details-modal-footer'),
            promptModal: document.getElementById('prompt-modal'),
            promptModalTitle: document.getElementById('prompt-modal-title'),
            promptForm: document.getElementById('prompt-form'),
            cancelPrompt: document.getElementById('cancel-prompt'),
            toast: document.getElementById('toast-notification'),
            toastMessage: document.getElementById('toast-message'),
        };

        // --- MOCK DATA ---
        const MOCK_AGENTS = [
            { id: 'agent_1', name: 'Ana García', autoTranscribe: true },
            { id: 'agent_2', name: 'Luis Torres', autoTranscribe: false },
            { id: 'agent_3', name: 'Maria Rodriguez', autoTranscribe: true },
        ];
        const MOCK_CAMPAIGNS = [
            { id: 'camp_1', name: 'Campaña Admisiones 2024', autoTranscribe: true },
            { id: 'camp_2', name: 'Seguimiento de Leads', autoTranscribe: true },
            { id: 'camp_3', name: 'Soporte Técnico', autoTranscribe: false },
        ];
        const MOCK_CALLS = [
            { id: 'call_1', agentName: 'Ana García', campaign: 'Campaña Admisiones 2024', timestamp: new Date(Date.now() - 3600000), duration: '08:15', status: 'completed', analysisResult: { qualityScore: 92, sentiment: 'positivo' } },
            { id: 'call_2', agentName: 'Luis Torres', campaign: 'Seguimiento de Leads', timestamp: new Date(Date.now() - 7200000), duration: '04:30', status: 'transcribed' },
            { id: 'call_3', agentName: 'Ana García', campaign: 'Campaña Admisiones 2024', timestamp: new Date(Date.now() - 10800000), duration: '12:45', status: 'error' },
        ];
        const MOCK_PROMPTS = [
            { id: 'prompt_1', title: 'Análisis de Calidad Estándar', content: 'Analiza la siguiente transcripción y evalúa la calidad del servicio del asesor basándote en: saludo, identificación de necesidad, solución propuesta y despedida. Otorga un puntaje de 0 a 100.'},
            { id: 'prompt_2', title: 'Detección de Sentimiento del Cliente', content: 'Analiza la siguiente transcripción y determina el sentimiento general del alumno (positivo, negativo, neutral). Extrae las frases clave que justifican tu respuesta.'}
        ];
        
        // --- FUNCIONES DE INICIALIZACIÓN Y AUTENTICACIÓN ---
        
        async function initializeFirebase() {
            if (firebaseConfig.apiKey.includes("your-api-key")) {
                isFirebaseConnected = false;
                console.warn("App is running in simulation mode because the Firebase API key is a placeholder. Please replace it with your actual Firebase config to connect to the database. Data will not be saved.");
                return;
            }

            try {
				app = initializeApp(firebaseConfig);
				db = getFirestore(app);
				auth = getAuth(app);
                await signInAnonymously(auth);
                console.log("Signed in anonymously to Firebase.");
				isFirebaseConnected = true;
                checkAndGenerateMockData();
            } catch (error) {
                console.error("Firebase connection failed:", error);
				isFirebaseConnected = false;
				console.warn("App is running in simulation mode. Data will not be saved.");
            }
        }
        
        function setupLoginListeners() {
            DOM.loginSuperadmin.addEventListener('click', () => login('superadmin'));
            DOM.loginSupervisor.addEventListener('click', () => login('supervisor'));
            DOM.logoutBtn.addEventListener('click', logout);
        }

        function login(role) {
            currentUserRole = role;
            localStorage.setItem('userRole', role);
            DOM.loginScreen.classList.add('hidden');
            DOM.app.classList.remove('hidden');
            updateUIForRole();
        }

        function logout() {
            currentUserRole = null;
            localStorage.removeItem('userRole');
            DOM.loginScreen.classList.remove('hidden');
            DOM.app.classList.add('hidden');
            if (unsubscribeCalls) unsubscribeCalls();
            if (unsubscribeConfigs) unsubscribeConfigs();
            if (unsubscribePrompts) unsubscribePrompts();
        }
        
        function checkSession() {
            const storedRole = localStorage.getItem('userRole');
            if (storedRole) {
                login(storedRole);
            }
        }

        // --- LÓGICA DE UI ---

        function updateUIForRole() {
            DOM.navMenu.innerHTML = '';
            let defaultView = '';
            
            if (currentUserRole === 'superadmin') {
                DOM.userRoleDisplay.textContent = 'Rol: Superadministrador';
                addNavLink('dashboard', 'fas fa-tachometer-alt', 'Dashboard', 'Panel de Control');
                addNavLink('config', 'fas fa-cogs', 'Configuración', 'Configuración');
            } else { // supervisor
                DOM.userRoleDisplay.textContent = 'Rol: Supervisor';
                addNavLink('calls', 'fas fa-list-ul', 'Llamadas', 'Bandeja de Llamadas');
                addNavLink('analysis', 'fas fa-chart-pie', 'Análisis', 'Análisis y Reportes');
                addNavLink('prompts', 'fas fa-file-alt', 'Plantillas', 'Plantillas de Prompts');
                defaultView = 'calls';
            }
            navigateTo(defaultView || 'dashboard');
        }
        
        function addNavLink(view, iconClass, title, headerTitle) {
            const link = document.createElement('button');
            link.className = 'sidebar-icon text-gray-500 hover:text-indigo-600';
            link.title = title;
            link.innerHTML = `<i class="${iconClass} text-2xl"></i>`;
            link.addEventListener('click', () => navigateTo(view, headerTitle));
            DOM.navMenu.appendChild(link);
        }
        
        function navigateTo(view, headerTitle = 'Panel de Control') {
            DOM.headerTitle.textContent = headerTitle;
            DOM.contentArea.innerHTML = '';
            const templateId = `${currentUserRole}-${view}-template`;
            const template = document.getElementById(templateId);
            
            if (template) {
                const content = template.content.cloneNode(true);
                DOM.contentArea.appendChild(content);
                loadDataForView(view);
            } else {
                DOM.contentArea.innerHTML = `<p>Vista no encontrada: ${view}</p>`;
            }
        }
        
        function showToast(message) {
            DOM.toastMessage.textContent = message;
            DOM.toast.classList.remove('hidden');
            setTimeout(() => {
                DOM.toast.classList.add('hidden');
            }, 3000);
        }

        // --- RENDERIZADO Y MANEJO DE DATOS ---

        function loadDataForView(view) {
            if (currentUserRole === 'superadmin') {
                if (view === 'config') loadConfigData();
            }
            if (currentUserRole === 'supervisor') {
                if (view === 'calls') {
                    loadCallsData();
                    setupCallViewListeners();
                }
                if (view === 'analysis') {
                    loadAnalysisData();
                }
                if (view === 'prompts') {
                    loadPromptsData();
                }
            }
        }
        
        // Carga y renderiza configuraciones (Superadmin)
        function loadConfigData() {
            // ... (código existente sin cambios)
        }
        
        function renderConfigList(element, items) {
            // ... (código existente sin cambios)
        }

        async function handleConfigToggle(checkbox) {
            // ... (código existente sin cambios)
        }
        
        // Carga y renderiza llamadas (Supervisor)
        function loadCallsData() {
             if (!isFirebaseConnected) {
                console.warn("Firebase not connected. Rendering mock calls data.");
                const callsList = document.getElementById('calls-list');
                if (!callsList) return;
                
                callsList.innerHTML = MOCK_CALLS.length === 0 ? '<p class="text-gray-500 text-center mt-8">No hay llamadas recientes.</p>' : '';

                const displayCalls = MOCK_CALLS.map(mockCall => ({
                    ...mockCall,
                    timestamp: { toDate: () => mockCall.timestamp }
                }));
                
                displayCalls.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                
                displayCalls.forEach(call => {
                    const callCard = createCallCard(call);
                    callsList.appendChild(callCard);
                });
                return;
            }

            const callsCollection = collection(db, "calls");
            unsubscribeCalls = onSnapshot(callsCollection, (snapshot) => {
                const callsList = document.getElementById('calls-list');
                if (!callsList) return;
                
                callsList.innerHTML = snapshot.empty ? '<p class="text-gray-500 text-center mt-8">No hay llamadas recientes.</p>' : '';
                
                const calls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                calls.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                
                calls.forEach(call => {
                    const callCard = createCallCard(call);
                    callsList.appendChild(callCard);
                });
            });
        }
        
        function createCallCard(call) {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow-sm flex items-center justify-between hover:shadow-md transition-shadow cursor-pointer slide-in';
            card.dataset.callId = call.id;

            const statusInfo = {
                transcribed: { icon: 'fa-file-alt', color: 'blue-500', text: 'Transcrita' },
                analyzing: { icon: 'fa-spinner animate-spin', color: 'purple-500', text: 'Analizando...' },
                completed: { icon: 'fa-check-circle', color: 'green-500', text: 'Analizada' },
                error: { icon: 'fa-exclamation-triangle', color: 'red-500', text: 'Error' },
            };
            const currentStatus = statusInfo[call.status] || statusInfo.error;

            card.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="text-${currentStatus.color} text-2xl"><i class="fas ${currentStatus.icon}"></i></div>
                    <div>
                        <p class="font-semibold text-gray-800">${call.agentName}</p>
                        <p class="text-sm text-gray-500">${call.timestamp.toDate().toLocaleString()}</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <span class="text-sm text-gray-600 font-mono"><i class="far fa-clock mr-1"></i> ${call.duration}</span>
                    <span class="text-sm font-semibold text-${currentStatus.color} px-2 py-1 bg-${currentStatus.color}/10 rounded-full">${currentStatus.text}</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
            `;
            card.addEventListener('click', () => openCallDetails(call));
            return card;
        }

        // --- LÓGICA DE ANÁLISIS Y REPORTES ---
        function loadAnalysisData() {
            const advisorsSelect = document.getElementById('filter-advisors');
            const campaignsSelect = document.getElementById('filter-campaigns');
            const promptSelect = document.getElementById('prompt-template-select');

            // Llenar filtros
            advisorsSelect.innerHTML = MOCK_AGENTS.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            campaignsSelect.innerHTML = MOCK_CAMPAIGNS.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            
            // Llenar plantillas
             if (!isFirebaseConnected) {
                promptSelect.innerHTML = MOCK_PROMPTS.map(p => `<option value="${p.id}">${p.title}</option>`).join('');
            } else {
                const promptsCollection = collection(db, "prompts");
                onSnapshot(promptsCollection, (snapshot) => {
                    const prompts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     promptSelect.innerHTML = prompts.map(p => `<option value="${p.id}">${p.title}</option>`).join('');
                });
            }

            document.getElementById('generate-report-btn').addEventListener('click', handleGenerateReport);
        }

        function handleGenerateReport() {
            const btn = document.getElementById('generate-report-btn');
            const placeholder = document.getElementById('report-placeholder');
            const resultsArea = document.getElementById('report-results-area');
            
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner animate-spin"></i> Generando...`;
            placeholder.innerHTML = `<i class="fas fa-spinner animate-spin-slow text-5xl text-indigo-400"></i><p class="mt-4 text-gray-600">Analizando llamadas con Gemini, por favor espera...</p>`;
            resultsArea.classList.add('hidden');

            // Simulación de llamada a la IA
            setTimeout(() => {
                placeholder.classList.add('hidden');
                resultsArea.classList.remove('hidden');
                
                // Simulación de datos de reporte
                const summary = {
                    totalCalls: 5,
                    avgQuality: 89,
                    overallSentiment: 'Positivo'
                };
                generatedReportData = [
                    { advisor: 'Ana García', date: new Date().toLocaleDateString(), quality: 95, sentiment: 'Positivo', kpis: 'Saludo OK, Cierre OK' },
                    { advisor: 'Luis Torres', date: new Date().toLocaleDateString(), quality: 82, sentiment: 'Neutral', kpis: 'Faltó mencionar promoción' },
                    { advisor: 'Ana García', date: new Date().toLocaleDateString(), quality: 91, sentiment: 'Positivo', kpis: 'Saludo OK, Cierre OK' },
                ];

                renderReport(summary, generatedReportData);

                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-rocket"></i> Generar Reporte con IA`;
                document.getElementById('export-csv-btn').addEventListener('click', handleExportCSV);
            }, 3000);
        }

        function renderReport(summary, details) {
            const summaryContainer = document.getElementById('report-summary');
            summaryContainer.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                    <p class="text-sm text-gray-500">Llamadas Analizadas</p>
                    <p class="text-2xl font-bold text-gray-800">${summary.totalCalls}</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                    <p class="text-sm text-gray-500">Calidad Promedio</p>
                    <p class="text-2xl font-bold text-green-600">${summary.avgQuality}%</p>
                </div>
                 <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                    <p class="text-sm text-gray-500">Sentimiento General</p>
                    <p class="text-2xl font-bold text-gray-800">${summary.overallSentiment}</p>
                </div>
            `;
            
            const tableBody = document.getElementById('report-table-body');
            tableBody.innerHTML = details.map(row => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.advisor}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${row.quality}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.sentiment}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.kpis}</td>
                </tr>
            `).join('');
        }

        function handleExportCSV() {
            if (generatedReportData.length === 0) {
                showToast("No hay datos para exportar");
                return;
            }

            const headers = Object.keys(generatedReportData[0]);
            const csvRows = [
                headers.join(','),
                ...generatedReportData.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ];
            const csvString = csvRows.join('\n');
            
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'reporte_analisis.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- LÓGICA DE PLANTILLAS DE PROMPTS ---
        function loadPromptsData() {
            document.getElementById('add-prompt-btn').addEventListener('click', () => openPromptModal());
            DOM.cancelPrompt.addEventListener('click', () => DOM.promptModal.classList.add('hidden'));
            DOM.promptForm.addEventListener('submit', handleSavePrompt);

            if (!isFirebaseConnected) {
                renderPrompts(MOCK_PROMPTS);
                return;
            }

            const promptsCollection = collection(db, "prompts");
            unsubscribePrompts = onSnapshot(promptsCollection, (snapshot) => {
                const prompts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPrompts(prompts);
            });
        }
        
        function renderPrompts(prompts) {
            const list = document.getElementById('prompts-list');
            list.innerHTML = prompts.length > 0 ? '' : '<p class="text-gray-500 text-center mt-8">No has creado ninguna plantilla todavía.</p>';
            prompts.forEach(prompt => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-sm';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-gray-800">${prompt.title}</h4>
                            <p class="text-sm text-gray-600 mt-2 line-clamp-2">${prompt.content}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-prompt-btn text-gray-400 hover:text-indigo-600" data-id="${prompt.id}"><i class="fas fa-pencil-alt"></i></button>
                            <button class="delete-prompt-btn text-gray-400 hover:text-red-600" data-id="${prompt.id}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
            // Add event listeners after rendering
            list.querySelectorAll('.edit-prompt-btn').forEach(btn => btn.addEventListener('click', (e) => openPromptModal(prompts.find(p => p.id === e.currentTarget.dataset.id))));
            list.querySelectorAll('.delete-prompt-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeletePrompt(e.currentTarget.dataset.id)));
        }

        function openPromptModal(prompt = null) {
            DOM.promptForm.reset();
            document.getElementById('prompt-id').value = '';
            if (prompt) {
                DOM.promptModalTitle.textContent = 'Editar Plantilla';
                document.getElementById('prompt-id').value = prompt.id;
                document.getElementById('prompt-title').value = prompt.title;
                document.getElementById('prompt-content').value = prompt.content;
            } else {
                DOM.promptModalTitle.textContent = 'Nueva Plantilla';
            }
            DOM.promptModal.classList.remove('hidden');
        }

        async function handleSavePrompt(e) {
            e.preventDefault();
            const id = document.getElementById('prompt-id').value;
            const title = document.getElementById('prompt-title').value;
            const content = document.getElementById('prompt-content').value;
            const promptData = { title, content };

            if (!isFirebaseConnected) {
                showToast(`Plantilla "${title}" guardada (simulación).`);
                DOM.promptModal.classList.add('hidden');
                return;
            }

            try {
                if (id) {
                    await setDoc(doc(db, "prompts", id), promptData);
                    showToast('Plantilla actualizada con éxito');
                } else {
                    await addDoc(collection(db, "prompts"), promptData);
                    showToast('Plantilla creada con éxito');
                }
                DOM.promptModal.classList.add('hidden');
            } catch (error) {
                console.error("Error saving prompt: ", error);
                showToast('Error al guardar la plantilla');
            }
        }
        
        async function handleDeletePrompt(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta plantilla?')) return;

            if (!isFirebaseConnected) {
                showToast('Plantilla eliminada (simulación).');
                return;
            }

            try {
                await deleteDoc(doc(db, "prompts", id));
                showToast('Plantilla eliminada');
            } catch (error) {
                console.error("Error deleting prompt: ", error);
                showToast('Error al eliminar la plantilla');
            }
        }


        // --- LÓGICA DE MODALES (EXISTENTE) ---
        
        function setupCallViewListeners() {
            const manualUploadBtn = document.getElementById('manual-upload-btn');
            if (manualUploadBtn) {
                manualUploadBtn.addEventListener('click', () => DOM.uploadModal.classList.remove('hidden'));
            }
            DOM.cancelUpload.addEventListener('click', () => DOM.uploadModal.classList.add('hidden'));
            DOM.uploadForm.addEventListener('submit', handleManualUpload);
            
            DOM.closeDetailsModal.addEventListener('click', () => DOM.callDetailsModal.classList.add('hidden'));
            DOM.closeDetailsModalFooter.addEventListener('click', () => DOM.callDetailsModal.classList.add('hidden'));
        }

        async function handleManualUpload(e) {
            e.preventDefault();
            // ... (código existente sin cambios)
        }

        function openCallDetails(call) {
            // ... (código existente sin cambios)
        }
        
        function renderCallDetailsContent(call) {
            // ... (código existente sin cambios)
        }

        function getAnalysisHTML(call) {
            // ... (código existente sin cambios)
        }
        
        async function handleAnalyzeCall(callId) {
            // ... (código existente sin cambios)
        }

        // --- GENERACIÓN DE DATOS DE PRUEBA ---
        async function checkAndGenerateMockData() {
			if (!isFirebaseConnected) return;
            // ... (código existente para configs y calls)
            
            const promptsSnapshot = await getDocs(collection(db, "prompts"));
            if (promptsSnapshot.empty) {
                console.log("Generating mock prompts data...");
                for (const prompt of MOCK_PROMPTS) {
                    await addDoc(collection(db, "prompts"), prompt);
                }
            }
        }

        // --- PUNTO DE ENTRADA ---
        setupLoginListeners();
        initializeFirebase();
        checkSession();

    </script>
</body>
</html>

